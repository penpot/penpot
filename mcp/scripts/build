#!/usr/bin/env bash
# NOTE: this script should be called from the parent directory to
# properly work

SCRIPT_DIR=$(dirname $0);
URL=${1:-http://localhost:9090}

echo "Preparing bundle for types from $URL"

set -ex

corepack enable;
corepack install;

# Ensure clean working directory
rm -rf dist;
rm -rf node_modules;
rm -rf packages/server/dist;
rm -rf packages/server/node_modules;

pushd $SCRIPT_DIR;
set +e
./build-types $URL;
set -e
popd

pnpm -r --filter "!mcp-plugin" install;
pnpm -r --filter "mcp-server" run build:multi-user;

rsync -avr packages/server/dist/ ./dist/;

cp packages/server/package.json ./dist/;
cp packages/server/pnpm-lock.yaml ./dist/;

touch ./dist/pnpm-workspace.yaml;

cat <<EOF | tee ./dist/setup
#/usr/bin/env bash
set -e;
corepack enable;
corepack install;
pnpm install -P
EOF

chmod +x ./dist/setup;
